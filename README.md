# go-pgsql-search

A small Go web service that stores news items in PostgreSQL and uses vector embeddings (pgvector) for semantic search and AI-powered embeddings. The service reads training data from `assets/train.csv`, generates embeddings (via a local embedding service), and stores them in a Postgres database. The project auto-runs SQL migrations on startup and exposes HTTP endpoints for importing data and searching.

## Features

- Connects to PostgreSQL using GORM
- Ensures pgvector extension is created (via migration)
- Auto-runs SQL migrations from the `migrations/` directory
- Loads news data from `assets/train.csv` and stores title, description and vector embeddings
- Retrieves embeddings from a local embedding service at `http://localhost:11434/api/embeddings`
- Exposes HTTP endpoints for importing data and retrieving news

## Requirements

- Go 1.20+ (or your installed Go toolchain)
- PostgreSQL (accessible from the environment where the app runs)
- A local embedding service at `http://localhost:11434/api/embeddings` that returns JSON `{ "embedding": [ ... ] }`

## Environment variables

- `PORT` - Port for the HTTP server (e.g. `8080`)
- `DSN` - PostgreSQL DSN string. Example:

```
DSN="host=localhost user=postgres password=secret dbname=news port=5432 sslmode=disable"
```

Make sure the database exists and the user has permissions to create extensions and tables.

## Setup

1. Clone the repository:

   `git clone https://github.com/sambeetpanda507/go-pgsql-search.git`

2. Ensure Postgres is running and reachable. Create the database listed in your DSN if needed.

3. Set environment variables (example):
   ```bash
   export PORT=8080
   export DSN="host=localhost user=postgres password=secret dbname=news port=5432 sslmode=disable"
   ```

4. Ensure the embedding service is available at `http://localhost:11434/api/embeddings`. The app posts JSON `{ "model": "all-minilm", "prompt": "..." }` and expects a response `{ "embedding": [ ... ] }`.

5. Place a training CSV at `assets/train.csv`. The CSV loader expects the first row to be headers and uses columns for title and description.

6. Start the app:

   `go run main.go`

On startup the app will:
- Connect to Postgres using the `DSN` env var
- Create the pgvector extension by running `migrations/000_create_vector_extension.sql`
- Auto-migrate the `News` model
- Run any SQL files in the `migrations/` directory in sorted order

## HTTP Endpoints

- `GET /` and `GET /api` — Basic health endpoints returning `Ok`
- `GET /api/ping` — Health check (handled by `controllers.PingHandler`)
- `/api/news/from-file` — Imports news from `assets/train.csv` into the database and fills embeddings (calls the embedding service). Registered without an explicit method restriction.
- `/api/news` — Returns news rows (supports pagination and search via query params)
- `/api/news/fill-embedding` — Fills missing embeddings for existing rows
- `POST /api/ai/embedding` — Proxy endpoint that accepts JSON with `prompt` and forwards to the model server (returns the model response)

Note: CORS is enabled for origin `http://localhost:7080` by default via `middlewares.CORS`.

## Example: curl

- Simple health check:
```bash
curl http://localhost:8080/api/ping
```

- Trigger import from CSV (adjust method as desired):
```bash
curl -X POST http://localhost:8080/api/news/from-file
```

- Search with query:
```bash
curl "http://localhost:8080/api/news?search=bitcoin&page=0&limit=10"
```

- Request embedding:
```bash
curl -X POST http://localhost:8080/api/ai/embedding -H "Content-Type: application/json" -d '{"prompt":"hello world"}'
```

## Migrations

SQL migrations are stored in the `migrations/` directory and executed automatically on startup in lexicographical order. The code also specifically runs `migrations/000_create_vector_extension.sql` to install the `vector` extension required by pgvector.

## Troubleshooting

- "PORT is missing" — set the `PORT` environment variable
- Database connection errors — verify `DSN` and that Postgres accepts connections from the host
- Embedding errors — ensure the embedding server is running at `http://localhost:11434`

## Development notes

- Logging middleware prints request method, path, status and latency to stdout
- The DB connection uses GORM with minimal logging
- Embeddings are generated by `utils.GetEmbedding` and stored in the `News.Embedding` (pgvector)

## Contributing

Contributions are welcome. Open issues or pull requests with changes.

## License

No license file is included. Add a LICENSE if you want to specify licensing.
